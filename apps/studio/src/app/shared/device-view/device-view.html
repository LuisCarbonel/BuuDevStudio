<div
  class="device-view-shell"
  [ngStyle]="boundsStyle(layout?.bounds)"
  (pointerdown)="onBackgroundClick($event)"
  (pointerup)="$event.stopPropagation()"
>
  <svg
    class="device-view-svg"
    #svgRoot
    [attr.viewBox]="viewBox"
    role="img"
    aria-label="Device layout"
    (mouseleave)="onHover(null)"
    (pointerdown)="$event.stopPropagation()"
  >
    <rect
      *ngIf="layout as l"
      class="svg-bg-hit"
      [attr.x]="l.bounds.minX - padding"
      [attr.y]="l.bounds.minY - padding"
      [attr.width]="l.bounds.width + padding * 2"
      [attr.height]="l.bounds.height + padding * 2"
      fill="transparent"
      pointer-events="all"
      (pointerdown)="onBackgroundClick($event)"
    ></rect>

    <g class="keys">
      <ng-container *ngIf="layout">
        <g
          *ngFor="let key of layout.keys"
          class="key"
          [ngClass]="keyClasses(key)"
          (pointerdown)="onSelect(key.elementId); $event.stopPropagation()"
          (mouseenter)="onHover(key.elementId)"
          appSvgDrag
          [appSvgDragEnabled]="mode === 'edit'"
          [appSvgDragId]="key.elementId"
          [appSvgDragUnitPx]="unitPx"
          (appSvgDragMove)="onDragMove($event)"
        >
          <rect
            class="key-cap"
            [attr.x]="renderRect(key).x"
            [attr.y]="renderRect(key).y"
            [attr.width]="renderRect(key).w"
            [attr.height]="renderRect(key).h"
            [attr.rx]="0.22"
          ></rect>
          <text
            class="key-label"
            [attr.x]="renderRect(key).x + renderRect(key).w / 2"
            [attr.y]="renderRect(key).y + renderRect(key).h / 2"
            dominant-baseline="middle"
            text-anchor="middle"
          >
            {{ key.rawLabel || key.matrixId || key.elementId }}
          </text>
          <title *ngIf="bindingIndicators[key.elementId] as badge">{{ badge.label }}</title>
        </g>
      </ng-container>
    </g>

    <!-- Controls -->
    <g class="controls">
      <ng-container *ngIf="layout">
        <g
          *ngFor="let ctrl of layout.controls"
          class="control"
          [ngClass]="controlClasses(ctrl)"
          [attr.data-id]="ctrl.elementId"
          (pointerdown)="onSelect(ctrl.elementId); $event.stopPropagation()"
          (mouseenter)="onHover(ctrl.elementId)"
          appSvgDrag
          [appSvgDragEnabled]="mode === 'edit'"
          [appSvgDragId]="ctrl.elementId"
          [appSvgDragUnitPx]="unitPx"
          (appSvgDragMove)="onDragMove($event)"
        >
          <rect
            [attr.x]="ctrl.x"
            [attr.y]="ctrl.y"
            [attr.width]="renderRect(ctrl).w"
            [attr.height]="renderRect(ctrl).h"
            class="control-body"
            rx="0.14"
          ></rect>
          <text
            class="control-label"
            [attr.x]="renderRect(ctrl).x + renderRect(ctrl).w / 2"
            [attr.y]="renderRect(ctrl).y + renderRect(ctrl).h / 2"
            dominant-baseline="middle"
            text-anchor="middle"
          >
            {{ controlLabel(ctrl) }}
          </text>
          <title *ngIf="bindingIndicators[ctrl.elementId] as badge">{{ badge.label }}</title>
        </g>
      </ng-container>
    </g>
  </svg>

  <div
    class="drop-overlay"
    *ngIf="layout && dropEnabled && dropConnectedTo.length"
    aria-hidden="true"
  >
    <div
      *ngFor="let key of layout.keys"
      class="drop-hit"
      [ngStyle]="dropStyle(key)"
      appDropTarget
      [appDropTarget]="key.elementId"
      [appDropTargetConnectedTo]="dropConnectedTo"
      [appDropTargetSortingDisabled]="true"
      (click)="onSelect(key.elementId)"
      (mouseenter)="onHover(key.elementId)"
      (appDropTargetAssign)="onAssign(key.elementId, $event)"
    ></div>
    <div
      *ngFor="let ctrl of layout.controls"
      class="drop-hit"
      [ngStyle]="dropStyle(ctrl)"
      appDropTarget
      [appDropTarget]="ctrl.elementId"
      [appDropTargetConnectedTo]="dropConnectedTo"
      [appDropTargetSortingDisabled]="true"
      (click)="onSelect(ctrl.elementId)"
      (mouseenter)="onHover(ctrl.elementId)"
      (appDropTargetAssign)="onAssign(ctrl.elementId, $event)"
    ></div>
  </div>
</div>
