<nz-layout class="app-shell">
  <!-- Top toolbar -->
  <nz-header class="topbar">
    <div class="topbar__left">
      <div class="brand">BuuDevStudio</div>

      <nz-tag [nzColor]="isConnected ? 'green' : 'red'">
        {{ isConnected ? 'Connected' : 'Disconnected' }}
      </nz-tag>
      <nz-tag nzColor="blue">Transport: {{ transport }}</nz-tag>
    </div>

    <div class="topbar__right">
      <button nz-button nzType="default" (click)="toggleConnect()">
        {{ isConnected ? 'Disconnect' : 'Connect (mock)' }}
      </button>

      <button nz-button nzType="default" [disabled]="!isConnected" (click)="uploadToRam()">
        Upload to RAM
      </button>

      <button nz-button nzType="primary" [disabled]="!isConnected" (click)="run()">
        Run
      </button>

      <button nz-button nzDanger [disabled]="!isConnected" (click)="stopAll()">
        Stop All
      </button>

      <button nz-button nzType="default" [disabled]="!isConnected" (click)="commitToFlash()">
        Commit to Flash
      </button>
    </div>
  </nz-header>

  <!-- Main content -->
  <nz-content class="content">
    <nz-tabset [nzSelectedIndex]="activeTabIndex" (nzSelectedIndexChange)="onTabIndexChange($event)">
      <nz-tab nzTitle="Editor">
        <as-split class="split" direction="horizontal" [gutterSize]="6">
          <!-- Left: Scripts/Profiles -->
          <as-split-area [size]="20" [minSize]="14">
            <div class="pane">
              <div class="pane__title">Scripts & Profiles</div>
              <nz-tree [nzData]="treeNodes" (nzClick)="onTreeEvent($event)"></nz-tree>
            </div>
          </as-split-area>

          <!-- Center: Sequence editor -->
          <as-split-area [size]="55" [minSize]="35">
            <div class="pane">
              <div class="pane__title">Sequence</div>

              <div class="steps">
                <button
                  class="step"
                  *ngFor="let s of steps"
                  (click)="selectStep(s)"
                  [class.step--active]="s.id === selectedStepId"
                >
                  <span class="step__id">#{{ s.id }}</span>
                  <span class="step__op">{{ s.op }}</span>
                  <span class="step__arg" *ngIf="s.arg">{{ s.arg }}</span>
                  <span class="step__ms" *ngIf="s.ms != null">{{ s.ms }}ms</span>
                  <span class="step__class" *ngIf="s.class != null">C{{ s.class }}</span>
                </button>
              </div>
            </div>
          </as-split-area>

          <!-- Right: Inspector -->
          <as-split-area [size]="25" [minSize]="18">
            <div class="pane">
              <div class="pane__title">Inspector</div>

              <ng-container *ngIf="selectedStep as step; else noSelection">
                <div class="kv">
                  <div class="kv__row"><div class="k">Step</div><div class="v">#{{ step.id }}</div></div>
                  <div class="kv__row"><div class="k">Op</div><div class="v">{{ step.op }}</div></div>
                  <div class="kv__row" *ngIf="step.arg"><div class="k">Arg</div><div class="v">{{ step.arg }}</div></div>
                  <div class="kv__row" *ngIf="step.ms != null"><div class="k">Delay</div><div class="v">{{ step.ms }}ms</div></div>
                  <div class="kv__row" *ngIf="step.class != null"><div class="k">Class</div><div class="v">C{{ step.class }}</div></div>
                </div>
              </ng-container>

              <ng-template #noSelection>
                <div class="muted">Select a step to inspect/edit.</div>
              </ng-template>
            </div>
          </as-split-area>
        </as-split>
      </nz-tab>

      <nz-tab nzTitle="Device">
        <div class="tab-pad">
          <div class="pane__title">Device</div>
          <div class="muted">Coming next: real HID connection + device capabilities + logs.</div>
        </div>
      </nz-tab>

      <nz-tab nzTitle="Settings">
        <div class="tab-pad">
          <div class="pane__title">Settings</div>
          <div class="muted">Coming next: delay classes, micro-gap, jitter tuning, profiles.</div>
        </div>
      </nz-tab>
    </nz-tabset>
  </nz-content>
</nz-layout>
