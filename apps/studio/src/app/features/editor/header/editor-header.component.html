<div class="wb-header">
  <div class="header-row">
    <!-- Left: Connection Status -->
    <div class="status-section">
      <span class="connection-indicator" [class.connected]="connected" [class.busy]="busy">
        <span class="dot"></span>
        <span class="status-text">{{ connected ? 'Connected' : 'Disconnected' }}</span>
      </span>

      @if (connected && deviceName) {
        <span class="divider">???</span>
        <span class="device-name">{{ deviceName }}</span>
        <app-device-mode-badge [mode]="deviceMode"></app-device-mode-badge>
      }

      <!-- Compact metadata - Only show if important -->
      @if (connected && dirty) {
        <span class="status-badge status-badge--warning" nz-tooltip nzTooltipTitle="You have unsaved changes" nzTooltipOverlayClassName="studio-overlay studio-overlay--tooltip">
          <span nz-icon nzType="edit" nzTheme="outline"></span>
          Changes pending
        </span>
      }
    </div>

    <!-- Right: Actions -->
    <div class="actions-section">
      <!-- Disconnected State -->
      @if (!connected) {
        <!-- Device Selector -->
        <button
          nz-button
          nzType="default"
          nzSize="default"
          [nzDropdownMenu]="deviceMenu"
          nz-dropdown
          [nzOverlayClassName]="'studio-overlay studio-overlay--menu'"
          [disabled]="busy || !devices.length"
          class="device-selector-btn"
        >
          <span nz-icon nzType="laptop" nzTheme="outline"></span>
          {{ selectedDeviceId ? (getDeviceName(selectedDeviceId) || 'Select Device') : 'Select Device' }}
          <span nz-icon nzType="down"></span>
        </button>
        <nz-dropdown-menu #deviceMenu="nzDropdownMenu">
          <ul nz-menu>
            @for (d of devices; track d.id) {
              <li nz-menu-item (click)="connectDevice.emit(d.id)">
                <strong>{{ d.name || d.id }}</strong>
                @if (d.capabilityLevel) {
                  <span class="device-capability">{{ d.capabilityLevel }}</span>
                }
              </li>
            }
            @if (devices.length) {
              <li nz-menu-divider></li>
            }
            @if (!devices.length) {
              <li nz-menu-item [nzDisabled]="true">
                <span style="color: var(--text-muted); font-size: 0.9em;">No devices detected</span>
              </li>
            }
          </ul>
        </nz-dropdown-menu>

        <!-- Import Button -->
        <button
          nz-button
          nzType="default"
          nzSize="default"
          (click)="triggerImport()"
          [nzLoading]="importBusy"
          [disabled]="importBusy"
          class="icon-btn"
          nz-tooltip
          nzTooltipTitle="Import Configuration"
          nzTooltipOverlayClassName="studio-overlay studio-overlay--tooltip"
        >
          <span nz-icon nzType="import" nzTheme="outline"></span>
        </button>

        <!-- Primary Connect Button -->
        <button
          nz-button
          nzType="primary"
          nzSize="default"
          (click)="connect.emit()"
          [nzLoading]="busy"
          [disabled]="busy || !devices.length"
          class="primary-action"
        >
          <span nz-icon nzType="link" nzTheme="outline"></span>
          Connect
        </button>
      }

      <!-- Connected State -->
      @if (connected) {
        <!-- Switch Device -->
        <button
          nz-button
          nzType="default"
          nzSize="default"
          [nzDropdownMenu]="switchDeviceMenu"
          nz-dropdown
          [nzOverlayClassName]="'studio-overlay studio-overlay--menu'"
          [disabled]="busy"
          class="icon-btn"
          nz-tooltip
          nzTooltipTitle="Switch Device"
          nzTooltipOverlayClassName="studio-overlay studio-overlay--tooltip"
        >
          <span nz-icon nzType="swap" nzTheme="outline"></span>
        </button>
        <nz-dropdown-menu #switchDeviceMenu="nzDropdownMenu">
          <ul nz-menu>
            @for (d of devices; track d.id) {
              <li nz-menu-item (click)="connectDevice.emit(d.id)" [nzDisabled]="d.id === selectedDeviceId">
                @if (d.id === selectedDeviceId) {
                  <span nz-icon nzType="check-circle" nzTheme="fill" style="color: var(--accent-success);"></span>
                }
                <strong>{{ d.name || d.id }}</strong>
                @if (d.capabilityLevel) {
                  <span class="device-capability">{{ d.capabilityLevel }}</span>
                }
              </li>
            }
          </ul>
        </nz-dropdown-menu>

        <!-- Actions Dropdown -->
        <button
          nz-button
          nzType="primary"
          nzSize="default"
          [nzDropdownMenu]="actionsMenu"
          nz-dropdown
          [nzOverlayClassName]="'studio-overlay studio-overlay--menu'"
          [nzLoading]="busy"
          class="primary-action"
        >
          Actions
          <span nz-icon nzType="down"></span>
        </button>
        <nz-dropdown-menu #actionsMenu="nzDropdownMenu">
          <ul nz-menu>
            <!-- Studio HID Mode Actions -->
            @if (deviceMode === 'studio-hid') {
              <li nz-menu-item (click)="upload.emit()" [nzDisabled]="busy || !dirty">
                <span nz-icon nzType="upload" nzTheme="outline"></span>
                Upload to RAM
              </li>
              <li nz-menu-item (click)="revert.emit()" [nzDisabled]="busy || !ramLoaded">
                <span nz-icon nzType="reload" nzTheme="outline"></span>
                Revert
              </li>
              <li nz-menu-item (click)="commit.emit()" [nzDisabled]="busy || !ramLoaded">
                <span nz-icon nzType="save" nzTheme="outline"></span>
                Commit to Flash
              </li>
              <li nz-menu-divider></li>
              @if (!running) {
                <li nz-menu-item (click)="run.emit()" [nzDisabled]="busy">
                  <span nz-icon nzType="play-circle" nzTheme="outline"></span>
                  Run
                </li>
              }
              @if (running) {
                <li nz-menu-item (click)="stopAll.emit()" [nzDisabled]="busy">
                  <span nz-icon nzType="stop" nzTheme="outline"></span>
                  Stop All
                </li>
              }
            }

            <!-- Import (available in all states) -->
            @if (deviceMode === 'studio-hid') {
              <li nz-menu-divider></li>
            }
            <li nz-menu-item (click)="triggerImport()" [nzDisabled]="importBusy">
              <span nz-icon nzType="import" nzTheme="outline"></span>
              Import Configuration
            </li>

            <li nz-menu-divider></li>
            <li nz-menu-item (click)="disconnect.emit()" [nzDisabled]="busy">
              <span nz-icon nzType="disconnect" nzTheme="outline"></span>
              Disconnect
            </li>
          </ul>
        </nz-dropdown-menu>
      }

      <!-- Hidden file input -->
      <input
        #importInput
        type="file"
        accept=".json"
        (change)="importFile.emit($event)"
        hidden
      />
    </div>
  </div>
</div>
