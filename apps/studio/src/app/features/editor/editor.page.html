<div class="workbench">
    <app-editor-header
      *ngIf="vm$ | async as vm"
      [connected]="vm.connected"
      [busy]="vm.busy"
      [running]="vm.running"
      [ramLoaded]="vm.ramLoaded"
      [dirty]="syncStats.dirty"
      [appliedInSync]="appliedInSync"
      [deviceName]="deviceName"
      [sessionId]="syncStats.sessionId"
      [revision]="syncStats.committed?.revision ?? null"
      [layerOptions]="layerOptions"
      [activeLayer]="activeLayer"
      [libraryOpen]="libraryOpen"
      [devices]="(devices$ | async) || []"
      [selectedDeviceId]="selectedDeviceId || ''"
      (toggleLibrary)="toggleLibrary()"
      (selectLayer)="setLayer($event)"
      (connect)="device.connect()"
      (connectDevice)="onConnectDevice($event)"
      (disconnect)="device.disconnect()"
      (upload)="device.uploadToRam()"
      (revert)="device.revertRam()"
      (commit)="device.commitToFlash()"
      (run)="device.run()"
    (stopAll)="device.stopAll()"
  ></app-editor-header>

  <div
    class="wb-body"
    [class.library-closed]="!libraryOpen"
  >
    <div class="import-bar">
      <button class="btn ghost" type="button" (click)="importInput.click()" [disabled]="importBusy">
        {{ importBusy ? 'Importing...' : 'Import VIA/Vial JSON' }}
      </button>
      <input #importInput type="file" accept=".json" (change)="onImportFile($event)" hidden />
    </div>

    <app-editor-library
      *ngIf="libraryOpen"
      [profiles]="profiles"
      [selectedProfileId]="selectedProfile?.id || null"
      [sequancesForProfile]="sequancesForProfile"
      [selectedSequanceId]="selectedSequance?.id || null"
      [actions]="actions"
      [presets]="presets"
      (selectProfile)="selectProfile($event)"
      (selectSequance)="selectSequance($event)"
    ></app-editor-library>

    <app-editor-canvas
      [normalizedLayout]="normalizedLayout"
      [layoutMode]="layoutMode"
      [layoutUnitPx]="layoutUnitPx"
      [layoutSelectionId]="layoutSelectionId"
      [hoveredElementId]="hoveredElementId"
      [bindingIndicators]="bindingIndicators"
      [canvasView]="canvasView"
      [hasSequance]="!!selectedSequanceId"
      (toggleLayoutMode)="toggleLayoutMode()"
      (select)="onDeviceSelect($event)"
      (deselect)="onDeviceDeselect()"
      (hover)="onDeviceHover($event)"
      (moveDelta)="onDeviceMove($event)"
      (moveEnd)="onDeviceMoveEnd($event)"
      (assignDrop)="onDropAssign($event.targetId, $event.payload)"
      (canvasViewChange)="setCanvasView($event)"
    ></app-editor-canvas>

    <app-editor-inspector
      [selectedTargetId]="selectedTargetId"
      [selectedLayoutElement]="selectedLayoutElement"
      [assignedTargetIds]="assignedTargetIds"
      [activeLayer]="activeLayer"
      [selectedSequanceName]="selectedSequance?.name || null"
      [bindingType]="bindingType"
      [bindingSequanceId]="bindingSequanceId"
      [bindingAction]="bindingAction"
      [bindingActionArg]="bindingActionArg"
      [bindingInlineText]="bindingInlineText"
      [bindingProgramPath]="bindingProgramPath"
      [bindingErrors]="bindingErrors"
      [showSelectionSection]="canvasView === 'sequance'"
      [sequancesForProfile]="sequancesForProfile"
      [actions]="actions"
      [selectedStep]="selectedStep"
      (bindingTypeChange)="bindingType = $event"
      (bindingSequanceChange)="onBindingSequanceChange($event)"
      (bindingActionChange)="bindingAction = $event"
      (bindingActionArgChange)="bindingActionArg = $event"
      (bindingInlineTextChange)="bindingInlineText = $event"
      (bindingProgramPathChange)="bindingProgramPath = $event"
      (assign)="assignSelectedSequanceToTarget()"
      (clear)="clearBinding()"
    ></app-editor-inspector>
  </div>
</div>
