<div class="workbench">
    <app-editor-header
      [connected]="vm().connected"
      [busy]="vm().busy"
      [running]="vm().running"
      [ramLoaded]="vm().ramLoaded"
      [dirty]="hasPendingChanges()"
      [appliedInSync]="appliedInSync()"
      [deviceName]="deviceName()"
      [sessionId]="syncStats().sessionId"
      [revision]="syncStats().committed?.revision ?? null"
      [layerOptions]="layerOptions()"
      [activeLayer]="activeLayer()"
      [libraryOpen]="libraryOpen()"
      [capabilityLevel]="capabilityLevel()"
      [devices]="devices()"
      [selectedDeviceId]="selectedDeviceId() || ''"
      [deviceMode]="device.deviceMode()"
      [importBusy]="importBusy()"
      (toggleLibrary)="toggleLibrary()"
      (selectLayer)="setLayer($event)"
      (connect)="device.connect()"
      (connectDevice)="onConnectDevice($event)"
      (disconnect)="device.disconnect()"
      (upload)="device.uploadToRam()"
      (revert)="device.revertRam()"
      (commit)="device.commitToFlash()"
      (run)="device.run()"
      (stopAll)="device.stopAll()"
      (importFile)="onImportFile($event)"
  ></app-editor-header>

  <div
    class="wb-body"
    [class.library-closed]="!libraryOpen()"
  >
    @if (libraryOpen()) {
      <app-editor-library
        [profiles]="profiles()"
        [selectedProfileId]="selectedProfile()?.id || null"
        [sequencesForProfile]="sequencesForProfile()"
        [selectedSequenceId]="selectedSequence()?.id || null"
        [libraryMode]="libraryMode()"
        [librarySearch]="librarySearch()"
        [capabilities]="capabilities()"
        [libraryVariant]="'editor'"
        (selectProfile)="selectProfile($event)"
        (selectSequence)="selectSequence($event)"
        (modeChange)="onLibraryModeChange($event)"
        (searchChange)="onLibrarySearchChange($event)"
        (createSequence)="onCreateSequence()"
      ></app-editor-library>
    }

    <app-editor-canvas
      [normalizedLayout]="normalizedLayout()"
      [layoutUnitPx]="layoutUnitPx()"
      [layoutSelectionId]="layoutSelectionId()"
      [hoveredElementId]="hoveredElementId()"
      [bindingIndicators]="bindingIndicators()"
      [layerOptions]="layerOptions()"
      [activeLayer]="activeLayer()"
      [canvasView]="canvasView()"
      [hasSequence]="sequenceViewEnabled()"
      [keycodeLabels]="keycodeLabels()"
      [encoderLabels]="encoderLabels()"
      [libraryOpen]="libraryOpen()"
      (toggleLibrary)="toggleLibrary($event)"
      (selectLayer)="setLayer($event)"
      (select)="onDeviceSelect($event)"
      (deselect)="onDeviceDeselect()"
      (hover)="onDeviceHover($event)"
      (assignDrop)="onDropAssign($event.targetId, $event.payload)"
      (canvasViewChange)="setCanvasView($event)"
    ></app-editor-canvas>

    <app-editor-inspector
      [selectedTargetId]="selectedTargetId()"
      [selectedLayoutElement]="selectedLayoutElement()"
      [assignedTargetIds]="assignedTargetIds()"
      [activeLayer]="activeLayer()"
      [selectedSequenceName]="selectedSequence()?.name || null"
      [currentBinding]="currentBindingSnapshot() ?? selectedBinding()"
      [keycodeLabel]="selectedTargetId() ? keycodeLabels()[selectedTargetId()!] : null"
      [pendingBindingText]="pendingBindingLabelOverride()"
      [bindingType]="bindingType()"
      [bindingOptions]="bindingTypeOptions()"
      [bindingSequenceId]="bindingSequenceId()"
      [bindingAction]="bindingAction()"
      [bindingActionArg]="bindingActionArg()"
      [bindingInlineText]="bindingInlineText()"
      [bindingProgramPath]="bindingProgramPath()"
      [bindingErrors]="bindingErrors()"
      [showSelectionSection]="canvasView() === 'sequence'"
      [sequencesForProfile]="sequencesForProfile()"
      [actions]="actions"
      [selectedStep]="selectedStep()"
      [readOnly]="readOnlyPreview()"
      [capabilities]="capabilities()"
      [pendingChanges]="hasPendingChanges()"
      (bindingTypeChange)="onBindingTypeChange($event)"
      (bindingSequenceChange)="onBindingSequenceChange($event)"
      (bindingActionChange)="bindingAction.set($event)"
      (bindingActionArgChange)="bindingActionArg.set($event)"
      (bindingInlineTextChange)="bindingInlineText.set($event)"
      (bindingProgramPathChange)="bindingProgramPath.set($event)"
      (assign)="applyBinding()"
      (clear)="clearBinding()"
    ></app-editor-inspector>
  </div>
</div>
