<div class="library studio-panel">
  <div class="library-header">
    <div class="library-header-top">
      <h2 class="library-title">Library</h2>
      @if (profiles.length) {
        <div class="profile-badge">
          <span class="profile-name">{{ selectedProfileName }}</span>
        </div>
      }
    </div>

    <nz-segmented
      class="library-tabs"
      [nzOptions]="modeOptions"
      [ngModel]="libraryMode"
      (ngModelChange)="modeChange.emit($event)"
    ></nz-segmented>

    <div class="library-search">
      <input
        nz-input
        [placeholder]="searchPlaceholder"
        [ngModel]="librarySearch"
        (ngModelChange)="onSearchChange($event)"
      />
    </div>

    @if (libraryMode === 'blocks' && libraryVariant === 'editor') {
      <div class="library-filters">
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showAdvanced" (change)="toggleAdvanced()" />
          <span>Show Advanced</span>
        </label>
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showDanger" (change)="toggleDanger()" />
          <span>Show Danger</span>
        </label>
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showUnsupported" (change)="toggleUnsupported()" />
          <span>Show Unsupported</span>
        </label>
      </div>
    }

    @if (libraryMode === 'blocks' && libraryVariant === 'recorder') {
      <div class="library-filters">
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showAdvanced" (change)="toggleAdvanced()" />
          <span>Show Advanced</span>
        </label>
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showKeyboardActions" (change)="toggleKeyboardActions()" />
          <span>Show Keyboard Actions</span>
        </label>
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showUserKeys" (change)="toggleUserKeys()" />
          <span>Show User/Custom Keys</span>
        </label>
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showExperimentalMouse" (change)="toggleExperimentalMouse()" />
          <span>Experimental Mouse</span>
        </label>
        <label class="filter-toggle">
          <input type="checkbox" [checked]="showDanger" (change)="toggleDanger()" />
          <span>Show Danger</span>
        </label>
      </div>
    }
  </div>

  <div class="library-content studio-scroll--y">
    @switch (libraryMode) {
      @case ('blocks') {
        <div class="blocks-container">
          @for (cat of filteredBlockCategories; track cat.key) {
            <div class="category">
              <div class="category-label">{{ cat.label }}</div>
              <div
                class="block-grid"
                [class.block-grid--dense]="cat.density === 'dense'"
                cdkDropList
                [cdkDropListSortingDisabled]="true"
                [cdkDropListConnectedTo]="['canvasDrop']"
                [cdkDropListEnterPredicate]="blockListEnterPredicate"
              >
                @for (item of cat.items; track item.id) {
                  <button
                    class="block-item"
                    type="button"
                    (click)="onBlockClick(item, $event)"
                    appDragSource
                    cdkDragPreviewContainer="global"
                    [appDragSource]="blockPayload(item)"
                    [appDragSourceDisabled]="focusMode"
                    [title]="enableBlockClick ? 'Click to add to sequence' : null"
                  >
                    <ng-template cdkDragPreview>
                      <div class="block-item block-item--preview">
                        <span class="block-label">
                          @if (item.symbol) {
                            <span class="block-symbol">{{ item.symbol }}</span>
                          }
                          <span>{{ item.label }}</span>
                        </span>
                        @if (item.hint) {
                          <span class="block-hint">{{ item.hint }}</span>
                        }
                      </div>
                    </ng-template>
                    <ng-template cdkDragPlaceholder>
                      <div class="block-item block-item--placeholder"></div>
                    </ng-template>
                    <span class="block-label">
                      @if (item.symbol) {
                        <span class="block-symbol">{{ item.symbol }}</span>
                      }
                      <span>{{ item.label }}</span>
                    </span>
                    @if (item.hint) {
                      <span class="block-hint">{{ item.hint }}</span>
                    }
                    @if (item.level === 'danger' || item.level === 'advanced' || item.requires?.length) {
                      <span class="block-badges">
                        @if (item.level === 'danger') {
                          <span class="badge badge--danger">Danger</span>
                        }
                        @if (item.level === 'advanced') {
                          <span class="badge badge--advanced">Advanced</span>
                        }
                        @if (isUnsupported(item) === true) {
                          <span class="badge badge--unsupported">Unsupported</span>
                        }
                        @if (item.requires?.length) {
                          @if (requiresLabel(item); as label) {
                            <span class="badge badge--requires">{{ label }}</span>
                          }
                        }
                      </span>
                    }
                  </button>
                }
              </div>
            </div>
          }

          @if (filteredSequences.length) {
            <div class="category category--sequences">
              <div class="category-label">My Sequences</div>
              <div class="sequence-list">
                @for (s of filteredSequences; track s.id) {
                  <button
                    class="sequence-item"
                    [class.sequence-item--selected]="s.id === selectedSequenceId"
                    type="button"
                    (click)="selectSequence.emit(s.id)"
                    appDragSource
                    cdkDragPreviewContainer="global"
                    [appDragSource]="sequencePayload(s)"
                    [appDragSourceDisabled]="focusMode"
                  >
                    <ng-template cdkDragPreview>
                      <div class="sequence-item sequence-item--preview">
                        <span class="sequence-name">{{ s.name }}</span>
                      </div>
                    </ng-template>
                    <ng-template cdkDragPlaceholder>
                      <div class="sequence-item sequence-item--placeholder"></div>
                    </ng-template>
                    <span class="sequence-name">{{ s.name }}</span>
                  </button>
                }
              </div>
            </div>
          }

          @if (!filteredBlockCategories.length && !filteredSequences.length) {
            <div class="empty-state">
              <span class="empty-text">No results found</span>
            </div>
          }
        </div>
      }

      @case ('sequences') {
        <div class="sequences-container">
          @if (sequencesForProfile.length) {
            @if (filteredSequences.length) {
              <div class="sequence-list">
                @for (s of filteredSequences; track s.id) {
                  <button
                    class="sequence-item sequence-item--large"
                    [class.sequence-item--selected]="s.id === selectedSequenceId"
                    type="button"
                    (click)="selectSequence.emit(s.id)"
                    appDragSource
                    cdkDragPreviewContainer="global"
                    [appDragSource]="sequencePayload(s)"
                    [appDragSourceDisabled]="focusMode"
                  >
                    <ng-template cdkDragPreview>
                      <div class="sequence-item sequence-item--preview">
                        <span class="sequence-name">{{ s.name }}</span>
                      </div>
                    </ng-template>
                    <ng-template cdkDragPlaceholder>
                      <div class="sequence-item sequence-item--placeholder"></div>
                    </ng-template>
                    <span class="sequence-name">{{ s.name }}</span>
                    <span class="sequence-hint">Drag to bind or click to edit</span>
                  </button>
                }
              </div>
            } @else {
              <div class="empty-state">
                <span class="empty-text">No sequences match</span>
              </div>
            }
          } @else {
            <div class="empty-state empty-state--centered">
              <span class="empty-text">No sequences yet</span>
              <button nz-button nzType="primary" nzSize="small" (click)="createSequence.emit()">
                Create Sequence
              </button>
            </div>
          }
        </div>
      }
    }
  </div>
</div>
