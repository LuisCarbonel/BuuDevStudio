@if (deviceInfo; as d) {
  <div class="firmware-page">
    <header class="page-header">
      <div class="page-header__content">
        <h1 class="page-title">Device Firmware</h1>
        <p class="page-subtitle">Complete device snapshot from current session</p>
      </div>
      <div class="page-actions">
        <button class="btn btn--secondary" type="button" (click)="copyDeviceReport()">
          Copy Report
        </button>
        @if (d.capabilityLevel !== 'Studio HID') {
          <label class="btn btn--secondary">
            Import Definition
            <input type="file" accept=".json" hidden (change)="importDefinition($event)" />
          </label>
        }
        <button class="btn btn--secondary" type="button" (click)="probeVia()">
          Probe VIA
        </button>
        <button class="btn btn--secondary" type="button" (click)="rawHidProbe()">
          Raw HID Probe
        </button>
      </div>
    </header>

    <div class="content-grid">
      <section class="info-card">
        <div class="card-header">
          <h2 class="card-title">Device Information</h2>
          @if (d.connected) {
            <span class="status-badge status-badge--connected">Connected</span>
          }
        </div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Name</span>
            <span class="info-value">{{ d.name || 'Unnamed Device' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Capability</span>
            <span class="info-value">
              <span class="capability-badge" [class.capability-badge--studio]="d.capabilityLevel === 'Studio HID'">
                {{ d.capabilityLevel || 'Generic HID' }}
              </span>
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Manufacturer</span>
            <span class="info-value">{{ d.manufacturer || 'Unknown' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Product</span>
            <span class="info-value">{{ d.product || 'Unknown' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Transport</span>
            <span class="info-value">{{ d.transport }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Firmware Version</span>
            <span class="info-value">{{ d.firmwareVersion || 'Unknown' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Serial Number</span>
            <span class="info-value info-value--mono">{{ d.serial || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Unique ID</span>
            <span class="info-value info-value--mono">{{ uniqueId }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Fingerprint</span>
            <span class="info-value info-value--mono">{{ d.fingerprint || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Session ID</span>
            <span class="info-value info-value--mono">{{ d.sessionId || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Definition</span>
            <span class="info-value">
              <span class="status-indicator" [class.status-indicator--success]="definitionLinked">
                {{ definitionLinked ? 'Linked' : 'Not Linked' }}
              </span>
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">Active Profile</span>
            <span class="info-value">{{ activeProfile?.name || 'None' }}</span>
          </div>
        </div>
      </section>

      <section class="info-card">
        <div class="card-header">
          <h2 class="card-title">Capabilities</h2>
        </div>
        <div class="capabilities-grid">
          <div class="capability-item" [class.capability-item--enabled]="capabilities.layouts">
            <span class="capability-indicator"></span>
            <span class="capability-name">Layouts</span>
          </div>
          <div class="capability-item" [class.capability-item--enabled]="capabilities.keymap">
            <span class="capability-indicator"></span>
            <span class="capability-name">Keymap</span>
          </div>
          <div class="capability-item" [class.capability-item--enabled]="capabilities.sequences">
            <span class="capability-indicator"></span>
            <span class="capability-name">Sequences</span>
          </div>
          <div class="capability-item" [class.capability-item--enabled]="capabilities.volatileApply">
            <span class="capability-indicator"></span>
            <span class="capability-name">Volatile Apply</span>
          </div>
          <div class="capability-item" [class.capability-item--enabled]="capabilities.commit">
            <span class="capability-indicator"></span>
            <span class="capability-name">Commit</span>
          </div>
        </div>
      </section>

      <section class="info-card">
        <div class="card-header">
          <h2 class="card-title">Device State</h2>
          @if (device.isDirty()) {
            <span class="status-badge status-badge--warning">Modified</span>
          }
        </div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Committed Revision</span>
            <span class="info-value">{{ d.committedState?.revision ?? 'None' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Applied Revision</span>
            <span class="info-value">{{ d.appliedState?.revision ?? 'None' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Staged Revision</span>
            <span class="info-value">{{ d.stagedState?.revision ?? 'None' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Definition Fingerprint</span>
            <span class="info-value info-value--mono">{{ definitionFingerprint }}</span>
          </div>
        </div>
        <div class="card-actions">
          <button class="btn btn--primary" type="button" (click)="rebindDefinition()">
            Bind Definition to Device
          </button>
        </div>
      </section>
    </div>

    @if ((d.interfaces?.length ?? 0) > 0) {
      <section class="info-card info-card--full">
        <div class="card-header">
          <h2 class="card-title">HID Interfaces</h2>
          <span class="card-subtitle">{{ d.interfaces?.length || 0 }} interface(s)</span>
        </div>
        <div class="interfaces-list">
          @for (iface of d.interfaces ?? []; track $index) {
            <div class="interface-item">
              <div class="interface-header">
                <span class="interface-label">{{ iface.label || 'HID Interface' }}</span>
                <div class="interface-meta">
                  <span class="interface-usage">UP {{ iface.usagePage | number:'2.0' }}</span>
                  <span class="interface-usage">U {{ iface.usage | number:'2.0' }}</span>
                  @if (iface.interfaceNumber !== undefined && iface.interfaceNumber !== null) {
                    <span class="interface-usage">IF {{ iface.interfaceNumber }}</span>
                  }
                  @if (iface.usagePage === 65376 && iface.usage === 97) {
                    <span class="badge badge--raw">Raw HID</span>
                  }
                </div>
              </div>
              @if (iface.path) {
                <div class="interface-path">{{ iface.path }}</div>
              }
            </div>
          }
        </div>
      </section>
    }
    @if (inspector(); as inspect) {
      <section class="info-card info-card--full">
        <div class="card-header">
          <h2 class="card-title">Device Inspector</h2>
          <span class="card-subtitle">Raw backend inspection data</span>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Vendor ID</span>
            <span class="info-value info-value--mono">{{ inspect.vendorId || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Product ID</span>
            <span class="info-value info-value--mono">{{ inspect.productId || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Manufacturer</span>
            <span class="info-value">{{ inspect.manufacturer || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Product</span>
            <span class="info-value">{{ inspect.product || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Serial</span>
            <span class="info-value info-value--mono">{{ inspect.serial || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Fingerprint</span>
            <span class="info-value info-value--mono">{{ inspect.fingerprint || 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Capability Level</span>
            <span class="info-value">{{ inspect.capabilityLevel || 'Generic HID' }}</span>
          </div>
        </div>
        @if (inspect.interfaces?.length) {
          <div class="interfaces-list">
            @for (iface of inspect.interfaces; track $index) {
              <div class="interface-item">
                <div class="interface-header">
                  <span class="interface-label">{{ iface.label || 'HID Interface' }}</span>
                  <div class="interface-meta">
                    <span class="interface-usage">UP {{ iface.usagePage | number:'2.0' }}</span>
                    <span class="interface-usage">U {{ iface.usage | number:'2.0' }}</span>
                    @if (iface.interfaceNumber !== undefined && iface.interfaceNumber !== null) {
                      <span class="interface-usage">IF {{ iface.interfaceNumber }}</span>
                    }
                  </div>
                </div>
                @if (iface.path) {
                  <div class="interface-path">{{ iface.path }}</div>
                }
              </div>
            }
          </div>
        }
      </section>
    }
    @if (layoutMeta) {
      <section class="info-card">
        <div class="card-header">
          <h2 class="card-title">Layout Definition</h2>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Keys</span>
            <span class="info-value info-value--highlight">{{ layoutMeta.keys }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Encoders</span>
            <span class="info-value info-value--highlight">{{ layoutMeta.encoders }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Status</span>
            <span class="info-value">
              <span class="status-indicator" [class.status-indicator--success]="definitionLinked">
                {{ definitionLinked ? 'Linked' : 'Not Linked' }}
              </span>
            </span>
          </div>
        </div>
      </section>
    }
    @if (viaProbe(); as via) {
      <section class="info-card">
        <div class="card-header">
          <h2 class="card-title">VIA Protocol</h2>
          <span class="status-badge" [class.status-badge--success]="via.viaDetected" [class.status-badge--muted]="!via.viaDetected">
            {{ via.viaDetected ? 'Detected' : 'Not Detected' }}
          </span>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Protocol Version</span>
            <span class="info-value">{{ via.viaProtocolVersion ?? 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Write Length</span>
            <span class="info-value">{{ via.writeLen ?? 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Read Length</span>
            <span class="info-value">{{ via.readLen ?? 'N/A' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Timeout</span>
            <span class="info-value">{{ via.timeoutMs ?? 'N/A' }}ms</span>
          </div>
          <div class="info-item info-item--full">
            <span class="info-label">First Bytes</span>
            <span class="info-value info-value--mono">{{ via.firstBytes || 'N/A' }}</span>
          </div>
        </div>
      </section>
    }
    @if (viaState(); as viaState) {
      <section class="info-card info-card--full">
        <div class="card-header">
          <h2 class="card-title">VIA Keymap</h2>
          <span class="card-subtitle">Read-only keymap data</span>
        </div>
        @if (!viaState.viaDetected) {
          <div class="empty-state">No VIA data available</div>
        }
        @if (viaState.viaDetected) {
          <div class="keymap-stats">
            <div class="stat-item">
              <span class="stat-label">Layers</span>
              <span class="stat-value">{{ viaState.layers || viaState.keymap.length }}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Macros</span>
              <span class="stat-value">{{ viaState.macros?.length ?? 0 }}</span>
            </div>
          </div>
          @if (viaState.keymap.length) {
            <div class="keymap-container">
              @for (layer of viaState.keymap; track $index) {
                <div class="via-layer">
                  <div class="via-layer-header">
                    <span class="via-layer-title">Layer {{ $index }}</span>
                  </div>
                  <div class="via-table-wrapper">
                    <table class="via-table">
                      @for (row of layer; track $index) {
                        <tr>
                          <td class="via-cell via-cell--header">R{{ $index }}</td>
                          @for (key of row; track $index) {
                            <td class="via-cell">
                              <div class="via-cell-content">
                                <span class="via-cell-id">C{{ $index }}</span>
                                <span class="via-cell-code">{{ key }}</span>
                              </div>
                            </td>
                          }
                        </tr>
                      }
                    </table>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">VIA detected; keymap not available yet</div>
          }
        }
      </section>
    }
  </div>
}
